package app.android.pathtrace.main

import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.os.Message
import android.util.Log
import com.google.android.material.snackbar.Snackbar
import androidx.appcompat.app.AppCompatActivity
import android.view.Menu
import android.view.MenuItem
import app.android.pathtrace.R
import app.android.pathtrace.obj.ObjReader
import app.android.pathtrace.pathtracer.*
import app.android.pathtrace.rendering.RenderRunnable

import kotlinx.android.synthetic.main.activity_main.*
import java.util.*
import java.util.concurrent.BlockingQueue
import java.util.concurrent.LinkedBlockingQueue
import java.util.concurrent.ThreadPoolExecutor
import java.util.concurrent.TimeUnit

class MainActivity : AppCompatActivity() {

    private val threads = 8

    private val workQueue : BlockingQueue<Runnable> = LinkedBlockingQueue<Runnable>(128)
    private val threadPool : ThreadPoolExecutor = ThreadPoolExecutor(threads, 128, 1000, TimeUnit.SECONDS, workQueue)

    private var currentIdx = 0
    private var activeThreads = 0

    private val verticalTiles = 16
    private val horizontalTiles = 10

    private val tileCollection = arrayOfNulls<RenderFragment>(verticalTiles * horizontalTiles)
    private lateinit var meshes : Array<Mesh>
    private val objTest = "# Blender v2.80 (sub 75) OBJ File: 'scene.blend'\n" +
            "# www.blender.org\n" +
            "mtllib untitled.mtl\n" +
            "o Light\n" +
            "v 10.526047 -0.647999 0.196357\n" +
            "v 10.526047 -0.971551 -0.287874\n" +
            "v 10.526047 -1.542741 -0.401491\n" +
            "v 10.526047 -2.026972 -0.077938\n" +
            "v 10.631015 -0.647999 0.239836\n" +
            "v 10.973418 -0.971551 -0.102567\n" +
            "v 11.053757 -1.542741 -0.182906\n" +
            "v 10.824970 -2.026972 0.045881\n" +
            "v 10.674494 -0.647999 0.344805\n" +
            "v 11.158725 -0.971551 0.344805\n" +
            "v 11.272342 -1.542741 0.344805\n" +
            "v 10.948789 -2.026972 0.344805\n" +
            "v 10.631015 -0.647999 0.449773\n" +
            "v 10.973418 -0.971551 0.792176\n" +
            "v 11.053757 -1.542741 0.872515\n" +
            "v 10.824970 -2.026972 0.643728\n" +
            "v 10.526047 -2.155209 0.344805\n" +
            "v 10.526047 -0.647999 0.493252\n" +
            "v 10.526047 -0.971551 0.977483\n" +
            "v 10.526047 -1.542741 1.091099\n" +
            "v 10.526047 -2.026972 0.767547\n" +
            "v 10.526047 -0.633378 0.344805\n" +
            "v 10.421079 -0.647999 0.449773\n" +
            "v 10.078676 -0.971551 0.792175\n" +
            "v 9.998337 -1.542741 0.872515\n" +
            "v 10.227123 -2.026972 0.643728\n" +
            "v 10.377600 -0.647999 0.344805\n" +
            "v 9.893369 -0.971551 0.344805\n" +
            "v 9.779752 -1.542741 0.344804\n" +
            "v 10.103305 -2.026972 0.344805\n" +
            "v 10.421079 -0.647999 0.239836\n" +
            "v 10.078676 -0.971551 -0.102566\n" +
            "v 9.998337 -1.542741 -0.182905\n" +
            "v 10.227123 -2.026972 0.045881\n" +
            "vt 0.250000 0.687500\n" +
            "vt 0.375000 0.937500\n" +
            "vt 0.250000 0.937500\n" +
            "vt 0.625000 0.687500\n" +
            "vt 0.750000 0.937500\n" +
            "vt 0.625000 0.937500\n" +
            "vt 0.625000 0.187500\n" +
            "vt 0.500000 0.437500\n" +
            "vt 0.500000 0.187500\n" +
            "vt 0.625000 0.437500\n" +
            "vt 0.750000 0.687500\n" +
            "vt 0.671875 0.000000\n" +
            "vt 0.375000 0.687500\n" +
            "vt 0.375000 0.437500\n" +
            "vt 0.500000 0.937500\n" +
            "vt 0.125000 0.687500\n" +
            "vt 1.000000 0.937500\n" +
            "vt 1.000000 0.687500\n" +
            "vt 0.375000 0.187500\n" +
            "vt 0.546875 0.000000\n" +
            "vt 0.390625 1.000000\n" +
            "vt 0.250000 0.437500\n" +
            "vt 0.250000 0.187500\n" +
            "vt 0.875000 0.687500\n" +
            "vt 0.875000 0.937500\n" +
            "vt 0.421875 0.000000\n" +
            "vt 0.265625 1.000000\n" +
            "vt 0.125000 0.437500\n" +
            "vt 0.125000 0.187500\n" +
            "vt 0.875000 0.187500\n" +
            "vt 0.750000 0.187500\n" +
            "vt 0.921875 0.000000\n" +
            "vt 0.296875 0.000000\n" +
            "vt 0.140625 1.000000\n" +
            "vt 0.125000 0.937500\n" +
            "vt 1.000000 0.437500\n" +
            "vt 1.000000 0.187500\n" +
            "vt 0.171875 0.000000\n" +
            "vt 0.015625 1.000000\n" +
            "vt 0.000000 0.187500\n" +
            "vt 0.875000 0.437500\n" +
            "vt 0.000000 0.687500\n" +
            "vt 0.046875 0.000000\n" +
            "vt 0.890625 1.000000\n" +
            "vt 0.765625 1.000000\n" +
            "vt 0.640625 1.000000\n" +
            "vt 0.500000 0.687500\n" +
            "vt 0.515625 1.000000\n" +
            "vt 0.796875 0.000000\n" +
            "vt 0.750000 0.437500\n" +
            "vt 0.000000 0.437500\n" +
            "vn 0.2243 0.8103 0.5414\n" +
            "vn 0.2243 0.8103 -0.5414\n" +
            "vn 0.7861 -0.5253 -0.3256\n" +
            "vn 0.3764 0.1807 -0.9087\n" +
            "vn 0.2882 -0.9501 -0.1194\n" +
            "vn 0.9087 0.1807 0.3764\n" +
            "vn 0.5414 0.8103 0.2243\n" +
            "vn -0.5414 0.8103 0.2243\n" +
            "vn 0.2882 -0.9501 0.1194\n" +
            "vn 0.0979 0.9944 0.0406\n" +
            "vn 0.3256 -0.5253 0.7862\n" +
            "vn 0.3764 0.1807 0.9087\n" +
            "vn -0.5414 0.8103 -0.2243\n" +
            "vn 0.1194 -0.9501 0.2882\n" +
            "vn 0.0406 0.9944 0.0979\n" +
            "vn -0.3764 0.1807 0.9087\n" +
            "vn -0.3256 -0.5253 0.7862\n" +
            "vn -0.1194 -0.9501 -0.2882\n" +
            "vn -0.1194 -0.9501 0.2882\n" +
            "vn -0.0406 0.9944 0.0979\n" +
            "vn -0.7862 -0.5253 0.3256\n" +
            "vn -0.9087 0.1807 0.3764\n" +
            "vn -0.2882 -0.9501 0.1194\n" +
            "vn -0.0979 0.9944 0.0406\n" +
            "vn -0.7861 -0.5253 -0.3256\n" +
            "vn -0.9087 0.1807 -0.3764\n" +
            "vn -0.2882 -0.9501 -0.1194\n" +
            "vn -0.0979 0.9944 -0.0406\n" +
            "vn -0.3256 -0.5253 -0.7861\n" +
            "vn -0.0406 0.9944 -0.0979\n" +
            "vn 0.0406 0.9944 -0.0979\n" +
            "vn 0.9087 0.1807 -0.3764\n" +
            "vn 0.5414 0.8103 -0.2243\n" +
            "vn 0.0979 0.9944 -0.0406\n" +
            "vn -0.2243 0.8103 -0.5414\n" +
            "vn 0.7862 -0.5253 0.3256\n" +
            "vn 0.3256 -0.5253 -0.7862\n" +
            "vn -0.2243 0.8103 0.5414\n" +
            "vn 0.1194 -0.9501 -0.2882\n" +
            "vn -0.3764 0.1807 -0.9087\n" +
            "vn -0.7862 -0.5253 -0.3256\n" +
            "vn -0.3256 -0.5253 -0.7862\n" +
            "vn 0.7861 -0.5253 0.3256\n" +
            "usemtl None\n" +
            "s off\n" +
            "f 19/1/1 13/2/1 18/3/1\n" +
            "f 6/4/2 1/5/2 5/6/2\n" +
            "f 8/7/3 11/8/3 12/9/3\n" +
            "f 7/10/4 2/11/4 6/4/4\n" +
            "f 8/7/5 12/9/5 17/12/5\n" +
            "f 11/8/6 14/13/6 15/14/6\n" +
            "f 14/13/7 9/15/7 13/2/7\n" +
            "f 24/16/8 27/17/8 28/18/8\n" +
            "f 12/9/9 16/19/9 17/20/9\n" +
            "f 9/15/10 22/21/10 13/2/10\n" +
            "f 16/19/11 20/22/11 21/23/11\n" +
            "f 20/22/12 14/13/12 19/1/12\n" +
            "f 32/24/13 27/17/13 31/25/13\n" +
            "f 16/19/14 21/23/14 17/26/14\n" +
            "f 13/2/15 22/27/15 18/3/15\n" +
            "f 25/28/16 19/1/16 24/16/16\n" +
            "f 21/23/17 25/28/17 26/29/17\n" +
            "f 34/30/18 4/31/18 17/32/18\n" +
            "f 21/23/19 26/29/19 17/33/19\n" +
            "f 18/3/20 22/34/20 23/35/20\n" +
            "f 26/29/21 29/36/21 30/37/21\n" +
            "f 29/36/22 24/16/22 28/18/22\n" +
            "f 26/29/23 30/37/23 17/38/23\n" +
            "f 23/35/24 22/39/24 27/17/24\n" +
            "f 30/40/25 33/41/25 34/30/25\n" +
            "f 33/41/26 28/42/26 32/24/26\n" +
            "f 30/37/27 34/30/27 17/43/27\n" +
            "f 27/17/28 22/44/28 31/25/28\n" +
            "f 33/41/29 4/31/29 34/30/29\n" +
            "f 31/25/30 22/45/30 1/5/30\n" +
            "f 1/5/31 22/46/31 5/6/31\n" +
            "f 11/8/32 6/4/32 10/47/32\n" +
            "f 10/47/33 5/6/33 9/15/33\n" +
            "f 5/6/34 22/48/34 9/15/34\n" +
            "f 1/5/35 32/24/35 31/25/35\n" +
            "f 12/9/36 15/14/36 16/19/36\n" +
            "f 4/31/37 7/10/37 8/7/37\n" +
            "f 24/16/38 18/3/38 23/35/38\n" +
            "f 4/31/39 8/7/39 17/49/39\n" +
            "f 2/11/40 33/41/40 32/24/40\n" +
            "f 19/1/1 14/13/1 13/2/1\n" +
            "f 6/4/2 2/11/2 1/5/2\n" +
            "f 8/7/3 7/10/3 11/8/3\n" +
            "f 7/10/4 3/50/4 2/11/4\n" +
            "f 11/8/6 10/47/6 14/13/6\n" +
            "f 14/13/7 10/47/7 9/15/7\n" +
            "f 24/16/8 23/35/8 27/17/8\n" +
            "f 16/19/11 15/14/11 20/22/11\n" +
            "f 20/22/12 15/14/12 14/13/12\n" +
            "f 32/24/13 28/42/13 27/17/13\n" +
            "f 25/28/16 20/22/16 19/1/16\n" +
            "f 21/23/17 20/22/17 25/28/17\n" +
            "f 26/29/21 25/28/21 29/36/21\n" +
            "f 29/36/22 25/28/22 24/16/22\n" +
            "f 30/40/41 29/51/41 33/41/41\n" +
            "f 33/41/26 29/51/26 28/42/26\n" +
            "f 33/41/42 3/50/42 4/31/42\n" +
            "f 11/8/32 7/10/32 6/4/32\n" +
            "f 10/47/33 6/4/33 5/6/33\n" +
            "f 1/5/35 2/11/35 32/24/35\n" +
            "f 12/9/43 11/8/43 15/14/43\n" +
            "f 4/31/37 3/50/37 7/10/37\n" +
            "f 24/16/38 19/1/38 18/3/38\n" +
            "f 2/11/40 3/50/40 33/41/40\n" +
            "o Ship\n" +
            "v 9.977885 -0.613586 -1.994680\n" +
            "v 10.867818 -0.752698 -0.208996\n" +
            "v 10.345926 1.352025 -2.024972\n" +
            "v 11.235859 1.212913 -0.239288\n" +
            "v 8.225012 -0.271505 -1.094450\n" +
            "v 9.114944 -0.410617 0.691234\n" +
            "v 8.593053 1.694107 -1.124742\n" +
            "v 9.482985 1.554994 0.660942\n" +
            "v 11.287169 -0.444131 -2.174555\n" +
            "v 11.812050 -0.526179 -1.121359\n" +
            "v 11.504239 0.715185 -2.192420\n" +
            "v 12.029120 0.633136 -1.139225\n" +
            "v 7.581481 0.184634 -0.380839\n" +
            "v 8.187467 0.089908 0.835096\n" +
            "v 7.832093 1.523088 -0.401466\n" +
            "v 8.438079 1.428362 0.814469\n" +
            "v 9.991381 -0.581658 0.241119\n" +
            "v 9.068902 1.585685 -2.378651\n" +
            "v 10.359422 1.383954 0.210827\n" +
            "v 8.700861 -0.379927 -2.348360\n" +
            "v 10.374858 -0.939464 -1.097888\n" +
            "v 9.086013 1.880872 -0.235850\n" +
            "v 10.838886 1.538791 -1.136080\n" +
            "v 8.621984 -0.597383 -0.197658\n" +
            "v 11.521302 -0.636334 -1.645627\n" +
            "v 11.794987 0.825339 -1.668153\n" +
            "v 8.167767 1.650263 0.203812\n" +
            "v 7.851793 -0.037267 0.229818\n" +
            "v 9.298127 -0.737114 -1.049670\n" +
            "v 9.762156 1.741141 -1.087862\n" +
            "vt 0.625000 0.000000\n" +
            "vt 0.500000 0.250000\n" +
            "vt 0.500000 0.000000\n" +
            "vt 0.500000 0.375000\n" +
            "vt 0.625000 0.500000\n" +
            "vt 0.500000 0.500000\n" +
            "vt 0.375000 1.000000\n" +
            "vt 0.375000 0.750000\n" +
            "vt 0.375000 0.750000\n" +
            "vt 0.625000 0.750000\n" +
            "vt 0.500000 1.000000\n" +
            "vt 0.500000 0.750000\n" +
            "vt 0.500000 0.250000\n" +
            "vt 0.375000 0.250000\n" +
            "vt 0.500000 0.250000\n" +
            "vt 0.750000 0.625000\n" +
            "vt 0.875000 0.750000\n" +
            "vt 0.750000 0.750000\n" +
            "vt 0.375000 0.500000\n" +
            "vt 0.250000 0.750000\n" +
            "vt 0.250000 0.500000\n" +
            "vt 0.875000 0.750000\n" +
            "vt 0.750000 0.750000\n" +
            "vt 0.625000 1.000000\n" +
            "vt 0.625000 1.000000\n" +
            "vt 0.375000 0.250000\n" +
            "vt 0.375000 0.000000\n" +
            "vt 0.375000 0.000000\n" +
            "vt 0.625000 0.500000\n" +
            "vt 0.500000 0.750000\n" +
            "vt 0.500000 0.500000\n" +
            "vt 0.625000 0.250000\n" +
            "vt 0.625000 0.250000\n" +
            "vt 0.750000 0.500000\n" +
            "vt 0.625000 0.500000\n" +
            "vt 0.750000 0.500000\n" +
            "vt 0.875000 0.500000\n" +
            "vt 0.625000 0.250000\n" +
            "vt 0.375000 0.375000\n" +
            "vt 0.375000 0.250000\n" +
            "vt 0.625000 0.625000\n" +
            "vt 0.625000 0.500000\n" +
            "vt 0.375000 0.500000\n" +
            "vt 0.375000 0.500000\n" +
            "vt 0.875000 0.500000\n" +
            "vt 0.625000 0.750000\n" +
            "vt 0.125000 0.750000\n" +
            "vt 0.125000 0.500000\n" +
            "vt 0.625000 0.250000\n" +
            "vt 0.625000 0.375000\n" +
            "vt 0.375000 1.000000\n" +
            "vt 0.875000 0.625000\n" +
            "vt 0.375000 0.750000\n" +
            "vt 0.375000 0.250000\n" +
            "vt 0.625000 0.750000\n" +
            "vt 0.625000 0.000000\n" +
            "vn -0.9171 0.1661 -0.3624\n" +
            "vn -0.0336 0.9817 -0.1876\n" +
            "vn 0.1468 -0.0122 0.9891\n" +
            "vn 0.4450 -0.0696 0.8928\n" +
            "vn 0.6054 0.7956 0.0211\n" +
            "vn -0.1896 -0.9468 -0.2601\n" +
            "vn 0.8764 -0.1710 -0.4501\n" +
            "vn 0.0695 -0.9273 -0.3677\n" +
            "vn 0.7046 -0.1212 0.6992\n" +
            "vn -0.1374 0.0105 -0.9905\n" +
            "vn -0.8764 0.1710 0.4501\n" +
            "vn -0.6980 0.1198 -0.7060\n" +
            "vn -0.3894 -0.8339 0.3911\n" +
            "vn -0.2674 0.9621 -0.0538\n" +
            "vn -0.3874 -0.9082 -0.1585\n" +
            "vn 0.1643 0.9431 -0.2892\n" +
            "vn 0.2557 -0.0627 -0.9647\n" +
            "vn 0.2904 0.9334 0.2107\n" +
            "vn -0.0658 -0.9685 0.2400\n" +
            "vn -0.0592 0.9295 0.3640\n" +
            "vn -0.5976 -0.8014 -0.0267\n" +
            "vn 0.2768 -0.9597 0.0482\n" +
            "vn 0.3982 0.8280 -0.3948\n" +
            "vn -0.0368 0.9943 -0.1000\n" +
            "vn -0.1187 -0.9700 -0.2122\n" +
            "vn -0.3946 -0.9162 -0.0705\n" +
            "vn 0.2390 0.9405 -0.2416\n" +
            "vn 0.1894 0.9655 0.1784\n" +
            "vn -0.0324 -0.9901 0.1367\n" +
            "vn -0.1716 -0.9629 0.2082\n" +
            "vn 0.3287 0.9384 0.1069\n" +
            "usemtl Material\n" +
            "s off\n" +
            "f 39/52/44 52/53/44 54/54/44\n" +
            "f 64/55/45 41/56/45 56/57/45\n" +
            "f 42/58/46 48/59/46 40/60/46\n" +
            "f 36/61/47 53/62/47 51/63/47\n" +
            "f 57/64/48 46/65/48 60/66/48\n" +
            "f 63/67/49 35/68/49 55/69/49\n" +
            "f 43/70/50 60/71/50 59/72/50\n" +
            "f 55/69/51 43/73/51 59/74/51\n" +
            "f 36/61/52 46/75/52 38/76/52\n" +
            "f 37/77/53 43/78/53 35/79/53\n" +
            "f 49/80/54 62/81/54 61/82/54\n" +
            "f 39/52/55 49/83/55 41/84/55\n" +
            "f 58/85/56 48/86/56 62/87/56\n" +
            "f 56/57/57 49/80/57 61/82/57\n" +
            "f 39/88/58 63/67/58 58/85/58\n" +
            "f 51/63/47 42/58/47 40/60/47\n" +
            "f 37/89/59 64/55/59 57/64/59\n" +
            "f 54/54/60 37/77/60 35/79/60\n" +
            "f 57/64/61 53/90/61 38/91/61\n" +
            "f 58/85/62 51/92/62 40/93/62\n" +
            "f 56/57/63 50/94/63 42/95/63\n" +
            "f 58/85/64 47/96/64 39/88/64\n" +
            "f 61/82/54 48/59/54 50/94/54\n" +
            "f 55/69/65 44/97/65 36/61/65\n" +
            "f 59/72/50 46/98/50 44/99/50\n" +
            "f 51/92/62 55/69/62 36/61/62\n" +
            "f 57/64/66 45/100/66 37/89/66\n" +
            "f 53/90/61 56/57/61 42/95/61\n" +
            "f 39/52/44 41/84/44 52/53/44\n" +
            "f 64/55/67 52/101/67 41/56/67\n" +
            "f 42/58/46 50/102/46 48/59/46\n" +
            "f 36/61/47 38/76/47 53/62/47\n" +
            "f 57/64/48 38/91/48 46/65/48\n" +
            "f 63/67/68 54/103/68 35/68/68\n" +
            "f 43/70/50 45/104/50 60/71/50\n" +
            "f 55/69/51 35/68/51 43/73/51\n" +
            "f 36/61/52 44/97/52 46/75/52\n" +
            "f 37/77/53 45/105/53 43/78/53\n" +
            "f 49/80/54 47/106/54 62/81/54\n" +
            "f 39/52/55 47/107/55 49/83/55\n" +
            "f 58/85/56 40/93/56 48/86/56\n" +
            "f 56/57/57 41/56/57 49/80/57\n" +
            "f 39/88/69 54/103/69 63/67/69\n" +
            "f 51/63/47 53/62/47 42/58/47\n" +
            "f 37/89/70 52/101/70 64/55/70\n" +
            "f 54/54/60 52/53/60 37/77/60\n" +
            "f 57/64/71 64/55/71 53/90/71\n" +
            "f 58/85/72 63/67/72 51/92/72\n" +
            "f 56/57/63 61/82/63 50/94/63\n" +
            "f 58/85/64 62/87/64 47/96/64\n" +
            "f 61/82/54 62/81/54 48/59/54\n" +
            "f 55/69/65 59/74/65 44/97/65\n" +
            "f 59/72/50 60/71/50 46/98/50\n" +
            "f 51/92/73 63/67/73 55/69/73\n" +
            "f 57/64/66 60/66/66 45/100/66\n" +
            "f 53/90/74 64/55/74 56/57/74\n" +
            "o Cube\n" +
            "v 6.829414 -3.486390 2.388536\n" +
            "v 6.829414 1.902014 2.388536\n" +
            "v 8.851128 -3.486390 -2.606219\n" +
            "v 8.851128 1.902014 -2.606219\n" +
            "v 11.824169 -3.486390 4.410250\n" +
            "v 11.824169 1.902014 4.410250\n" +
            "v 13.845882 -3.486390 -0.584506\n" +
            "v 13.845882 1.902014 -0.584506\n" +
            "vt 0.375000 0.250000\n" +
            "vt 0.625000 0.000000\n" +
            "vt 0.375000 0.000000\n" +
            "vt 0.375000 0.500000\n" +
            "vt 0.625000 0.250000\n" +
            "vt 0.125000 0.750000\n" +
            "vt 0.125000 0.500000\n" +
            "vt 0.625000 0.750000\n" +
            "vt 0.875000 0.500000\n" +
            "vt 0.625000 0.500000\n" +
            "vt 0.375000 0.750000\n" +
            "vt 0.875000 0.750000\n" +
            "vn 0.9269 0.0000 0.3752\n" +
            "vn -0.3752 0.0000 0.9269\n" +
            "vn 0.0000 1.0000 0.0000\n" +
            "vn 0.0000 -1.0000 -0.0000\n" +
            "usemtl None\n" +
            "s off\n" +
            "f 67/108/75 66/109/75 65/110/75\n" +
            "f 71/111/76 68/112/76 67/108/76\n" +
            "f 65/113/77 71/111/77 67/114/77\n" +
            "f 70/115/78 68/116/78 72/117/78\n" +
            "f 67/108/75 68/112/75 66/109/75\n" +
            "f 71/111/76 72/117/76 68/112/76\n" +
            "f 65/113/77 69/118/77 71/111/77\n" +
            "f 70/115/78 66/119/78 68/116/78"

    private val handler: Handler = object : Handler(Looper.getMainLooper()) {
        override fun handleMessage(inputMessage: Message) {
            val frag = inputMessage.obj as RenderFragment
            Log.d("Task", "Received Tile ${frag.id}")
            renderScreen.pushChanges(frag)
            activeThreads -= 1
            render()
        }
    }

    @ExperimentalUnsignedTypes
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        setSupportActionBar(toolbar)

        fab.setOnClickListener { view ->
            Snackbar.make(view, "Replace with your own action", Snackbar.LENGTH_LONG)
                    .setAction("Action", null).show()
        }

        meshes = ObjReader.parseObj(objTest)
        meshes.forEach { m -> m.setColor(Col(255.toUByte(), 255.toUByte(), 255.toUByte())) }
        meshes.first { m -> m.name == "Light" }.setAsLight()
        meshes.first { m -> m.name == "Ship" }.setColor(Col(22.toUByte(), 110.toUByte(), 45.toUByte()))
    }

    override fun onCreateOptionsMenu(menu: Menu): Boolean {
        // Inflate the menu; this adds items to the action bar if it is present.
        menuInflater.inflate(R.menu.menu_main, menu)
        return true
    }

    override fun onOptionsItemSelected(item: MenuItem): Boolean {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        return when (item.itemId) {
            R.id.action_settings -> true
            else -> super.onOptionsItemSelected(item)
        }
    }

    override fun onWindowFocusChanged(hasFocus: Boolean) {
        super.onWindowFocusChanged(hasFocus)

        renderScreen.viewTreeObserver.addOnGlobalLayoutListener {
            initTiles()
            render()
        }
    }

    private fun initTiles() {
        val tileWidth = renderScreen.width / horizontalTiles
        val tileHeight = renderScreen.height / verticalTiles

        var counter = 0
        for(x in 0 until horizontalTiles) {
            for(y in 0 until verticalTiles) {
                val frag = RenderFragment(counter,x * tileWidth, tileWidth, y * tileHeight, tileHeight)
                tileCollection[counter] = frag
                counter += 1
            }
        }
    }

    private fun render() {
        val s = Scene(*meshes)
        while(activeThreads < threads) {
            threadPool.execute(
                RenderRunnable(s, renderScreen.width, renderScreen.height, 4, tileCollection[currentIdx]!!, handler)
            )
            currentIdx = (currentIdx + 1) % tileCollection.size
            activeThreads += 1
        }
    }
}
